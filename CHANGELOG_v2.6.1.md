# WatchFile.Core v2.6.1 发布说明

发布日期：2025-10-20

## 🎉 新功能

### 自动编码检测
- **智能BOM检测**：自动识别UTF-8、UTF-16 LE/BE、UTF-32 LE/BE等编码格式
- **中文编码智能识别**：自动检测GBK/GB2312编码的CSV文件（无BOM）
- **编码回退机制**：检测失败时自动使用配置的编码

### 增强的数据表格展示
- 测试程序新增表格格式数据展示功能
- 支持当前数据和历史数据对比显示
- 智能列宽调整和内容截断
- 数据统计信息展示（行数、列数、变化统计）

## 🔧 重要修复

### 空值字段处理
- **修复**：CSV文件中的空值字段（连续逗号`,\,`或Tab`\t\t`）现在能正确处理
- **修复**：必需字段为空时使用类型默认值而不是抛出异常或跳过记录
- **修复**：非必需字段为空时正确添加到记录中

### 编码提供程序注册
- **修复**：自动注册编码提供程序，支持GB2312/GBK等中文编码
- **修复**：编码检测阶段提前注册，避免GBK编码不可用的问题

### 数据解析改进
- **改进**：空字段不再导致整条记录被跳过
- **改进**：更准确的空值判断（包括空白字符）
- **改进**：更健壮的类型转换错误处理

## 📊 支持的编码格式

### 带BOM的编码（自动检测）
- UTF-8 (EF BB BF)
- UTF-16 LE (FF FE)
- UTF-16 BE (FE FF)
- UTF-32 LE (FF FE 00 00)
- UTF-32 BE (00 00 FE FF)

### 无BOM的编码（智能检测）
- GBK (自动检测中文字节范围 B0-F7)
- GB2312 (GBK不可用时的回退选项)

### 配置支持的编码
- UTF-8 / UTF8
- GBK
- GB2312
- ASCII
- UNICODE / UTF-16 / UTF16 (UTF-16 LE)
- UTF-16BE / UTF16BE
- UTF-32 / UTF32

## 🎯 使用示例

### 自动编码检测示例

文件会自动检测编码，无需配置：

```json
{
  "watchItems": [{
    "fileSettings": {
      "encoding": "UTF-8",  // 作为回退选项
      "fileType": "CSV"
    }
  }]
}
```

即使配置为UTF-8，程序也会自动检测到GBK编码的文件并正确解析。

### 空值字段处理示例

CSV文件：
```csv
Name,Age,Email
John,30,john@example.com
Jane,,jane@example.com
Bob,25,
```

现在第2行（Age为空）和第3行（Email为空）都能正确解析：
- Age为空：使用默认值0（Integer类型）
- Email为空：使用DBNull.Value或空字符串（取决于Required设置）

## 🐛 已知问题

无重大已知问题。

## ⬆️ 升级指南

### 从 v2.5.0 升级

1. **完全向后兼容**：无需修改现有代码
2. **受益于新功能**：
   - 现有的GBK/GB2312 CSV文件将自动正确检测
   - 空值字段将被正确处理而不会导致记录丢失
3. **建议操作**：
   - 测试包含空值字段的CSV文件
   - 验证中文编码文件的自动检测

### 从 v2.0.0 或更早版本升级

请先查看 v2.5.0 和 v2.6.0 的升级指南。

## 📝 API 变更

### 无重大变更

所有变更都是内部实现改进，不影响公共API。

### 新增私有方法
- `DetectFileEncoding()` - 自动检测文件编码
- `GetDefaultValueForType()` - 获取类型默认值

## 🔗 相关资源

- [完整文档](https://github.com/szsamkee/WatchFile)
- [智能删除指南](./SMART_DELETE_GUIDE.md)
- [数据展示指南](./DATA_DISPLAY_GUIDE.md)
- [空值处理指南](./NULL_VALUE_HANDLING.md)

## 🙏 致谢

感谢所有用户的反馈和建议，特别是关于编码检测和空值处理的问题报告。

---

**完整变更历史**: [CHANGELOG.md](./CHANGELOG.md)
